<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Salas del Infierno ‚Äì UI Mejorada</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Share+Tech+Mono&family=New+Rocker&display=swap" rel="stylesheet">
  <script src="verificarId.js"></script>
  <style>
    :root{
      --bg-1:#0b0000; --bg-2:#180000; --accent:#ff3a3a; --muted:#ffb6b6; --glass:rgba(255,255,255,0.03);
      --glass-2:rgba(255,255,255,0.02);
      --neon:rgba(255,58,58,0.16);
      --success:#60d394;
      --danger:#ff4d4d;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-1),#050000);color:var(--muted);font-family:'Inter', 'Share Tech Mono', system-ui, sans-serif;overflow:hidden}

    /* Background canvas */
    #proc-bg{position:fixed;inset:0;width:100%;height:100%;z-index:0;filter:blur(10px) saturate(120%)}

    /* Layout */
    .wrap{position:relative;z-index:6;display:grid;grid-template-columns:360px 1fr;gap:20px;height:100vh;padding:24px}
    .card{border-radius:14px;padding:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,0,0,0.06);box-shadow:0 10px 40px rgba(0,0,0,0.6)}

    /* SIDEBAR */
    .sidebar{display:flex;flex-direction:column;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{width:56px;height:56px;border-radius:12px;background:radial-gradient(circle at 30% 20%,#ff7373 0%,#ae0000 40%,#3b0000 100%);display:grid;place-items:center;font-family:'New Rocker';font-size:20px;color:#111;box-shadow:0 6px 22px rgba(170,0,0,0.18);border:1px solid rgba(255,255,255,0.04)}
    .brand .meta{display:flex;flex-direction:column}
    .brand .meta .title{font-weight:800;color:var(--accent);letter-spacing:1px;text-transform:uppercase}
    .brand .meta .sub{font-size:12px;color:var(--muted);opacity:0.9}

    .sidebar-controls{display:flex;gap:8px}
    .btn{background:linear-gradient(180deg,var(--accent),#b20000);border:0;color:#111;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;box-shadow:0 6px 18px rgba(170,0,0,0.12)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#ffdede}
    .search{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.02)}
    .search input{background:transparent;border:0;color:var(--muted);outline:none;font-size:14px}

    .chat-list{flex:1;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:8px}
    .chat-item{display:flex;gap:12px;align-items:center;padding:8px;border-radius:10px;cursor:pointer;transition:all .16s;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.01));border-left:4px solid transparent}
    .chat-item:hover{transform:translateX(6px);border-left-color:#aa0000}
    .chat-item.active{background:linear-gradient(90deg,rgba(255,58,58,0.03),transparent);border-left-color:var(--accent);box-shadow:inset 0 0 18px rgba(255,58,58,0.02)}
    .avatar{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;font-weight:700;color:#111;background:linear-gradient(180deg,#ff7b7b,#b30000);box-shadow:0 6px 16px rgba(0,0,0,0.5)}
    .chat-meta{flex:1;display:flex;flex-direction:column}
    .chat-name{font-weight:700}
    .chat-sub{font-size:12px;color:var(--muted);opacity:0.9}

    /* MAIN */
    .main{display:flex;flex-direction:column;gap:12px;height:100%;min-height:0}
    .main-header{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,0,0,0.03);flex-shrink:0}
    .chat-info{display:flex;gap:12px;align-items:center}
    .members-preview{display:flex;gap:6px;align-items:center}
    .member-small{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;font-size:12px;background:linear-gradient(180deg,#ffb3b3,#cc0000)}

    .mensajes{flex:1;Overflow-y:auto;overflow-x:hidden;padding:18px;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg,rgba(0,0,0,0.02),transparent);border-radius:10px}
    .mensajes::-webkit-scrollbar{width:8px}
    .mensajes::-webkit-scrollbar-track{background:rgba(255,0,0,0.05);border-radius:10px}
    .mensajes::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#ff3a3a,#b20000);border-radius:10px}
    .mensajes::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,#ff5555,#d20000)}
    .mensaje-wrap{display:flex;flex-direction:column;gap:6px;max-width:75%}
    .mensaje{padding:12px;border-radius:12px;background:rgba(40,0,0,0.6);box-shadow:0 6px 20px rgba(0,0,0,0.6);font-family:'Share Tech Mono';white-space:pre-wrap}
    .izq{align-self:flex-start;border-left:4px solid #aa0000}
    .der{align-self:flex-end;background:linear-gradient(145deg,#440000,#6a0000);border-right:4px solid #ff5555}
    .sender{font-size:12px;color:#ffdede}
    .timestamp{font-size:11px;color:#ffbdbd;opacity:0.8}

    .input-area{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,0,0,0.04);align-items:center;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
    textarea#inputMensaje{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,0,0,0.06);background:#120000;color:#ffdede;font-family:'Share Tech Mono';resize:none;height:64px;outline:none}
    .actions{display:flex;gap:8px}

    /* Modals */
    .modal{position:fixed;inset:0;display:grid;place-items:center;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.72));z-index:9999}
    .modal .card{min-width:320px}
    .member-list{display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto;padding:8px}
    .member-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}

    /* Small helpers */
    .muted{color:var(--muted);font-size:13px}
    .tiny{font-size:12px;color:#ffbcbc}

    /* responsive */
    @media(max-width:920px){
      .wrap{grid-template-columns:1fr;grid-template-rows:240px 1fr;padding:12px}
      .sidebar{height:220px;overflow:auto}
    }

    /* little entrance animations */
    .fade-in{animation:fadeIn .36s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

  </style>
  
  <!-- ‚≠ê SOCKET.IO CLIENT CDN ‚≠ê -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <canvas id="proc-bg" aria-hidden="true"></canvas>

  <div class="wrap" role="application">

    <aside class="sidebar card" aria-label="Lista de chats">
      <div class="brand">
        <div class="logo">SI</div>
        <div class="meta">
          <div class="title">Salas del Infierno</div>
          <div class="sub">Tus conversaciones ‚Äì versi√≥n fuego</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div class="search" role="search" aria-label="Buscar chats">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="#ff9b9b" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="11" cy="11" r="6" stroke="#ff9b9b" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></circle></svg>
          <input id="searchChats" placeholder="Buscar chats o miembros" />
        </div>
        <div style="display:flex;gap:8px;flex-shrink:0">
          <button id="btnCreateGroup" class="btn">+ Grupo</button>
          <button id="btnVolver" class="btn">‚Üê Volver</button>
        </div>
      </div>

      <div class="chat-list" id="chatList" aria-live="polite">
        <div class="card" style="background:transparent;border:0;color:#ff9999">Cargando chats‚Ä¶</div>
      </div>
    </aside>

    <main class="main">
      <div class="main-header card">
        <div style="display:flex;gap:12px;align-items:center" class="chat-info">
          <div id="activeAvatar" class="avatar">‚Äî</div>
          <div>
            <div id="chatTitleText" style="font-weight:800">Selecciona un chat...</div>
            <div id="chatSubtitle" class="muted tiny">Aqu√≠ ver√°s el estado y miembros</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="members-preview" id="membersPreview"></div>
          <button id="btnMembers" class="btn-ghost">Ver miembros</button>
          <button id="btnLeave" class="btn-ghost" title="Salir del grupo">Salir</button>
        </div>
      </div>

      <div class="mensajes card" id="mensajesContenedor" aria-live="polite">
        <div class="placeholder muted">Aqu√≠ se mostrar√° la conversaci√≥n.</div>
      </div>

      <div class="input-area card" id="inputAreaContainer" aria-hidden="true" style="display:none">
        <textarea id="inputMensaje" placeholder="Escribe tu mensaje... (Enter para enviar, Shift+Enter nueva l√≠nea)"></textarea>
        <div class="actions">
          <button id="emojiBtn" class="btn-ghost">üòä</button>
          <button id="sendBtn" class="btn">Enviar</button>
        </div>
      </div>
    </main>
  </div>

  <div id="modalRoot" style="display:none"></div>
  <div id="mensaje" role="status" aria-live="polite"></div>

  <script>
    const API_BASE = 'http://localhost:3000';

    /* --- Animated procedural background (fractal-like, lightweight) --- */
    (function(){
      const canvas = document.getElementById('proc-bg'), ctx = canvas.getContext('2d');
      let w,h,dpr=Math.min(window.devicePixelRatio||1,2), t0=performance.now();
      function resize(){ w=innerWidth; h=innerHeight; canvas.width=Math.round(w*dpr); canvas.height=Math.round(h*dpr); canvas.style.width=w+'px'; canvas.style.height=h+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); }
      window.addEventListener('resize', resize); resize();
      function loop(now){ const t=(now-t0)*0.001; ctx.clearRect(0,0,w,h); // simple moving radial gradients + noise overlay
        const grd = ctx.createLinearGradient(0,0,w,h); grd.addColorStop(0, '#120000'); grd.addColorStop(1, '#050000'); ctx.fillStyle = grd; ctx.fillRect(0,0,w,h);
        // glowing orbs
        for(let i=0;i<12;i++){ const x = (Math.sin(t*0.3 + i)*0.5+0.5)*w; const y = (Math.cos(t*0.27 + i*1.3)*0.5+0.5)*h; const r = 80 + (i*6)%100; const g = ctx.createRadialGradient(x,y,r*0.1,x,y,r); g.addColorStop(0, 'rgba(255,58,58,0.08)'); g.addColorStop(1, 'rgba(0,0,0,0)'); ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
        // subtle vignette
        ctx.fillStyle='rgba(0,0,0,0.25)'; ctx.fillRect(0,0,w,h);
        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);
    })();

    /* --- Helpers UI --- */
    function showToast(text, ms=3000){ const el=document.getElementById('mensaje'); el.textContent=text; el.classList.add('show'); el.style.opacity=1; setTimeout(()=>{ el.style.opacity=0; }, ms); }

    verificarID(()=> {
      const userId = sessionStorage.getItem('userId');
      if (!userId) { showToast('No hay sesi√≥n. Volviendo.'); setTimeout(()=> location.href='index.html',900); return; }

      const chatList = document.getElementById('chatList');
      const mensajesCont = document.getElementById('mensajesContenedor');
      const chatTitleText = document.getElementById('chatTitleText');
      const chatSubtitle = document.getElementById('chatSubtitle');
      const inputArea = document.getElementById('inputAreaContainer');
      const inputMsg = document.getElementById('inputMensaje');
      const membersPreview = document.getElementById('membersPreview');
      const activeAvatar = document.getElementById('activeAvatar');

      let datosChats = [], chatActual = null, usuariosGlobal = [];

      // ========== ‚≠ê SOCKET.IO TIEMPO REAL ‚≠ê ==========
      const socket = io(API_BASE, { 
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 1000
      });

      socket.on('connect', () => {
        console.log('‚úÖ Socket conectado:', socket.id);
        showToast('üî• Conectado en tiempo real');
      });

      socket.on('disconnect', () => {
        console.log('‚ùå Socket desconectado');
        showToast('Conexi√≥n perdida. Reconectando...');
      });

      socket.on('connect_error', (err) => {
        console.error('‚ö†Ô∏è Error de conexi√≥n socket:', err);
      });

      // Escuchar mensajes nuevos en tiempo real
      socket.on('recibirMensaje', (msg) => {
        console.log('üì® Mensaje recibido en tiempo real:', msg);
        
        if (chatActual && msg) {
          // Evitar duplicados
          const existe = chatActual.mensajes.some(m => m.id === msg.id);
          if (!existe) {
            chatActual.mensajes.push(msg);
            const elem = crearMensajeElemento(msg);
            mensajesCont.appendChild(elem);
            // Scroll autom√°tico al final
            requestAnimationFrame(() => {
              mensajesCont.scrollTop = mensajesCont.scrollHeight;
            });
          }
        }
      });

      // Actualizar lista de chats cuando hay cambios
      socket.on('chat:update', (data) => {
        console.log('üîÑ Chat actualizado:', data);
        cargarChats();
      });

      // Miembros actualizados
      socket.on('chat:membersUpdated', (data) => {
        console.log('üë• Miembros actualizados:', data);
        if (chatActual && chatActual.id === data.chatId) {
          chatActual.miembros = data.miembros;
          renderMembersPreview(chatActual);
          if (data.sysMsg) {
            chatActual.mensajes.push(data.sysMsg);
            mensajesCont.appendChild(crearMensajeElemento(data.sysMsg));
          }
        }
      });

      // Miembro sali√≥
      socket.on('chat:memberLeft', (data) => {
        console.log('üö™ Miembro sali√≥:', data);
        if (chatActual && chatActual.id === data.chatId) {
          chatActual.miembros = chatActual.miembros.filter(m => m !== data.usuario);
          renderMembersPreview(chatActual);
          if (data.sysMsg) {
            chatActual.mensajes.push(data.sysMsg);
            mensajesCont.appendChild(crearMensajeElemento(data.sysMsg));
          }
        }
      });

      // Chat renombrado
      socket.on('chat:renamed', (data) => {
        console.log('‚úèÔ∏è Chat renombrado:', data);
        if (chatActual && chatActual.id === data.chatId) {
          chatActual.displayName = data.displayName;
          chatTitleText.textContent = data.displayName;
        }
        cargarChats();
      });
      // ========== FIN SOCKET.IO ==========

      document.getElementById('btnVolver').addEventListener('click', ()=> location.href='tienda.html');
      document.getElementById('btnCreateGroup').addEventListener('click', showCreateGroupModal);
      document.getElementById('sendBtn').addEventListener('click', enviarMensaje);
      document.getElementById('btnMembers').addEventListener('click', ()=> openMembersModal(chatActual));
      document.getElementById('btnLeave').addEventListener('click', ()=> confirmLeaveGroup(chatActual));

      document.getElementById('searchChats').addEventListener('input', (e)=> renderChatList(e.target.value));

      inputMsg.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); enviarMensaje(); }
      });

      async function safeFetch(url, options){
        try{
          const fullUrl = url.startsWith('/') ? (API_BASE + url) : url;
          const res = await fetch(fullUrl, options);
          if (res.status === 404) throw { code:404, message:`Endpoint not found: ${url}` };
          const ct = res.headers.get('content-type')||'';
          if (!res.ok) { if (ct.includes('application/json')){ const j=await res.json(); throw j; } else { throw { message:'Server error', status: res.status }; } }
          if (ct.includes('application/json')) return res.json();
          return res.text();
        } catch(e){ throw e; }
      }

      /* --- Data loading --- */
      async function cargarChats(){
        try{
          const data = await safeFetch('/obtener-chats', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId }) });
          if (!data || !data.ok) { chatList.innerHTML = '<div class="card">No hay chats.</div>'; return; }
          datosChats = data.chats || [];
          renderChatList();
        } catch(err){ console.error('cargarChats err', err); chatList.innerHTML = `<div class="card">Error cargando chats. Revisa servidor.</div>`; }
      }

      function avatarFromName(name){ if(!name) return '??'; return name.split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase(); }

      function renderChatList(filter=''){
        chatList.innerHTML = '';
        const filtro = (filter||'').toLowerCase();
        const list = datosChats.filter(c=>{
          if (!filtro) return true;
          if ((c.displayName||'').toLowerCase().includes(filtro)) return true;
          if (Array.isArray(c.miembros) && c.miembros.join(' ').toLowerCase().includes(filtro)) return true;
          return false;
        });
        if (!list.length) { chatList.innerHTML = '<div class="card">No hay chats que coincidan.</div>'; return; }
        list.forEach(c=>{
          const item = document.createElement('div'); item.className='chat-item fade-in' + (chatActual && chatActual.id===c.id ? ' active':'');
          const ava = document.createElement('div'); ava.className='avatar'; ava.textContent = avatarFromName(c.displayName || (Array.isArray(c.miembros)?c.miembros[0]:'Chat'));
          const meta = document.createElement('div'); meta.className='chat-meta';
          const title = document.createElement('div'); title.className='chat-name'; title.textContent = c.displayName || c.chat || (Array.isArray(c.miembros)?c.miembros.join(' - '):'Chat');
          const sub = document.createElement('div'); sub.className='chat-sub'; sub.textContent = Array.isArray(c.miembros) ? `${c.miembros.length} miembros ‚Ä¢ ${c.mensajes?c.mensajes.length:0} mensajes` : '';
          meta.appendChild(title); meta.appendChild(sub);
          item.appendChild(ava); item.appendChild(meta);
          item.onclick = ()=> seleccionarChat(c);
          chatList.appendChild(item);
        });
      }

      function getMembers(chat){ if (!chat) return []; if (Array.isArray(chat.miembros) && chat.miembros.length) return chat.miembros; if (typeof chat.chat === 'string') return chat.chat.split(' - ').map(s=>s.trim()); return []; }

      function seleccionarChat(c){
        chatActual = datosChats.find(d => (d.id && c.id && d.id===c.id) || (d.chat && d.chat === c.chat)) || c;
        if (!chatActual) { showToast('Chat no disponible'); return; }
        
        chatTitleText.textContent = chatActual.displayName || chatActual.chat || getMembers(chatActual).join(' - ');
        chatSubtitle.textContent = chatActual.topic || (getMembers(chatActual).length + ' miembros');
        activeAvatar.textContent = avatarFromName(chatActual.displayName || getMembers(chatActual)[0] || '‚Äî');
        renderMessages(chatActual);
        inputArea.setAttribute('aria-hidden','false'); inputArea.style.display = 'flex';
        renderMembersPreview(chatActual);
        renderChatList(document.getElementById('searchChats').value);
        
        // ‚≠ê UNIRSE AL ROOM DE SOCKET.IO ‚≠ê
        if (socket && chatActual.id) {
          socket.emit('joinChat', { chatId: chatActual.id });
          console.log('üö™ Unido al room:', chatActual.id);
        }
      }

      function crearMensajeElemento(msg){
        const wrap = document.createElement('div'); wrap.className='mensaje-wrap';
        const sender = document.createElement('div'); sender.className='sender';
        sender.textContent = msg.de === userId ? 'T√∫' : (msg.nombre || msg.de);
        const bubble = document.createElement('div'); bubble.className='mensaje ' + (msg.de===userId ? 'der' : 'izq'); bubble.innerText = msg.mensaje;
        const ts = document.createElement('div'); ts.className='timestamp'; ts.textContent = new Date(msg.timestamp || Date.now()).toLocaleString();
        wrap.appendChild(sender); wrap.appendChild(bubble); wrap.appendChild(ts);
        return wrap;
      }

      function renderMessages(chat){
        mensajesCont.innerHTML = '';
        const msgs = (chat.mensajes||[]).slice(-200);
        if (!msgs.length) mensajesCont.innerHTML = '<div class="muted">No hay mensajes en este chat. S√© el primero.</div>';
        msgs.forEach(m=> mensajesCont.appendChild(crearMensajeElemento(m)));
        // Scroll al final despu√©s de renderizar
        requestAnimationFrame(() => {
          mensajesCont.scrollTop = mensajesCont.scrollHeight;
        });
      }

      async function enviarMensaje(){
        if (!chatActual) return showToast('Selecciona un chat');
        const texto = inputMsg.value.trim(); if (!texto) return;
        const nuevo = { de: userId, mensaje: texto, timestamp: Date.now() };
        
        // A√±adir mensaje localmente primero (optimistic UI)
        chatActual.mensajes = chatActual.mensajes || []; 
        chatActual.mensajes.push(nuevo);
        const elem = crearMensajeElemento(nuevo);
        mensajesCont.appendChild(elem);
        
        // Scroll autom√°tico al final
        requestAnimationFrame(() => {
          mensajesCont.scrollTop = mensajesCont.scrollHeight;
        });
        
        inputMsg.value = '';
        
        try {
          await safeFetch('/guardar-mensaje', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chatId: chatActual.id, de: userId, mensaje: texto }) });
          // El servidor ya emitir√° por socket, no necesitamos refresh
        } catch(e){ 
          console.error('guardar-mensaje err', e); 
          showToast('No se pudo enviar mensaje');
          // Remover mensaje si fall√≥
          chatActual.mensajes.pop();
          renderMessages(chatActual);
        }
      }

      async function obtenerUsuariosCache(){
        try { const res = await safeFetch('/obtener-usuarios', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId }) }); if (res && res.ok) usuariosGlobal = res.usuarios || []; } catch(e){ console.warn('no users', e); usuariosGlobal=[]; }
      }

      const modalRoot = document.getElementById('modalRoot');
      function openModal(html){ modalRoot.style.display='block'; modalRoot.innerHTML = `<div class="modal"><div class="card">${html}</div></div>`; return modalRoot.querySelector('.card'); }
      function closeModal(){ modalRoot.style.display='none'; modalRoot.innerHTML=''; }

      function getContactsForUser(){
        const ids = new Set();
        datosChats.forEach(ch => { if (Array.isArray(ch.miembros) && ch.miembros.includes(userId)) ch.miembros.forEach(m => { if (m !== userId) ids.add(m); }); });
        usuariosGlobal.forEach(u=> ids.add(u.id));
        return Array.from(ids).map(id => ({ id, nombre: id }));
      }

      function showCreateGroupModal(){
        Promise.all([obtenerUsuariosCache(), cargarChats()]).then(()=> {
          const contacts = getContactsForUser();
          const html = `<h3>Crear Grupo</h3><div class="small">Contactos</div><div id="contactList" style="max-height:240px;overflow:auto;margin-top:8px"></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="cancelCreate" class="btn-ghost">Cancelar</button><button id="confirmCreate" class="btn">Crear</button></div>`;
          const card = openModal(html); const list = card.querySelector('#contactList');
          if (!contacts.length) list.innerHTML = '<div class="muted">Sin contactos</div>'; else contacts.forEach(c => { const row = document.createElement('label'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px'; row.style.background='rgba(255,255,255,0.02)'; row.style.marginBottom='6px'; row.innerHTML = `<span>${c.nombre}</span><input type="checkbox" data-uid="${c.id}">`; list.appendChild(row); });
          card.querySelector('#cancelCreate').onclick = closeModal;
          card.querySelector('#confirmCreate').onclick = async () => {
            const selected = Array.from(card.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.dataset.uid);
            if (!selected.length) return alert('Selecciona al menos uno');
            const miembros = Array.from(new Set([userId, ...selected]));
            try {
              const created = await safeFetch('/crear-grupo',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ creador: userId, miembros, displayName: 'Grupo' }) });
              if (created && created.ok) { closeModal(); showToast('Grupo creado'); cargarChats(); } else alert('Error creando grupo');
            } catch(e){ console.error(e); alert('Error de red'); }
          };
        });
      }

      function renderMembersPreview(chat){
        membersPreview.innerHTML='';
        const members = getMembers(chat).slice(0,5);
        members.forEach(m=>{ const el=document.createElement('div'); el.className='member-small'; el.textContent=avatarFromName(m); el.title = m; el.onclick = ()=> showToast('Usuario: '+m); membersPreview.appendChild(el); });
        if (getMembers(chat).length > 5){ const more = document.createElement('div'); more.className='tiny muted'; more.textContent = `+${getMembers(chat).length - 5}`; membersPreview.appendChild(more); }
      }

      function openMembersModal(chat){ if (!chat) return showToast('Selecciona un chat');
        const members = getMembers(chat);
        const html = `<h3>Miembros ‚Äì ${chat.displayName || chat.chat || 'Grupo'}</h3><div class="member-list" id="memberList"></div><div style="display:flex;gap:8px;justify-content:space-between;margin-top:12px"><div style="display:flex;gap:8px"><input id="newMemberId" placeholder="ID usuario a a√±adir" style="padding:8px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.02);color:var(--muted)"></div><div><button id="cancelMembers" class="btn-ghost">Cerrar</button><button id="addMemberBtn" class="btn">A√±adir</button></div></div>`;
        const card = openModal(html); const list = card.querySelector('#memberList');
        members.forEach(m=>{
          const row = document.createElement('div'); row.className='member-row'; row.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div style='width:40px;height:40px;border-radius:8px;display:grid;place-items:center;background:linear-gradient(180deg,#ffb3b3,#cc0000);color:#111;font-weight:700'>${avatarFromName(m)}</div><div>${m}</div></div><div><button data-uid='${m}' class='btn-ghost small'>Ver</button></div>`;
          list.appendChild(row);
        });
        card.querySelector('#cancelMembers').onclick = closeModal;
        card.querySelector('#addMemberBtn').onclick = async ()=>{ 
          const newId = card.querySelector('#newMemberId').value.trim(); if (!newId) return alert('Escribe un ID');
          await addMemberToGroup(chat, newId); closeModal();
        };
      }

      async function addMemberToGroup(chat, memberId){
        if (!chat || !chat.id) return showToast('Chat no v√°lido');
        try{
          const res = await safeFetch('/agregar-miembro', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chatId: chat.id, miembro: memberId, peticionPor: userId }) });
          if (res && res.ok){ showToast('Miembro a√±adido');
            chat.miembros = Array.from(new Set([...(chat.miembros||[]), memberId])); renderMembersPreview(chat); cargarChats();
          } else { showToast('No se pudo a√±adir miembro'); }
        } catch(e){ console.error('agregar-miembro err', e); showToast('Error al intentar a√±adir miembro'); }
      }

      function confirmLeaveGroup(chat){ if (!chat) return showToast('Selecciona un chat');
        const html = `<h3>Salir del grupo</h3><p class="muted">Confirmas que quieres salir del grupo <strong>${chat.displayName||chat.chat||'Grupo'}</strong>?</p><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="cancelLeave" class="btn-ghost">Cancelar</button><button id="confirmLeave" class="btn" style="background:linear-gradient(180deg,#ff6b6b,#b20000)">Salir</button></div>`;
        const card = openModal(html);
        card.querySelector('#cancelLeave').onclick = closeModal;
        card.querySelector('#confirmLeave').onclick = async ()=>{ 
          closeModal(); await leaveGroup(chat);
        };
      }

      async function leaveGroup(chat){ if (!chat || !chat.id) return showToast('Chat no v√°lido');
        try{
          const res = await safeFetch('/salir-grupo', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chatId: chat.id, usuario: userId }) });
          if (res && res.ok){ showToast('Has salido del grupo');
            chat.miembros = (chat.miembros||[]).filter(m=> m!==userId);
            datosChats = datosChats.map(c => c.id===chat.id ? chat : c).filter(c=> !(Array.isArray(c.miembros) && c.miembros.length===0));
            chatActual = null; inputArea.style.display='none'; renderChatList(); mensajesCont.innerHTML = '<div class="muted">Selecciona un chat.</div>';
          } else { showToast('No se pudo salir del grupo'); }
        } catch(e){ console.error('salir-grupo err', e); showToast('Error al salir del grupo'); }
      }

      // Cargar inicial
      cargarChats();
      obtenerUsuariosCache();

      // Exponer para debugging
      window._ui = { datosChats, setDatos: (d)=>{ datosChats=d; renderChatList(); } };
    });
  </script>
</body>
</html>
