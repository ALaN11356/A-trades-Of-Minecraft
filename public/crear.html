<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crear Art√≠culo ‚Äî Tienda Infernal</title>

  <!-- Fuentes y script de verificaci√≥n (debe existir en la misma carpeta) -->
  <link href="https://fonts.googleapis.com/css2?family=New+Rocker&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <script src="verificarId.js"></script>

  <meta name="color-scheme" content="dark">
  <style>
    :root{--bg-1:#080000;--panel:#1a0000;--accent:#ff3a3a;--muted:#ffb6b6;--glass:rgba(255,255,255,0.03);--card-radius:14px}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#000;color:var(--accent);font-family:'New Rocker',cursive;overflow:hidden}
    #proc-bg{position:fixed;inset:0;width:100%;height:100%;z-index:0}
    main{position:relative;z-index:6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:40px}

    /* Card igual est√©tica tienda */
    .card{width:100%;max-width:760px;border-radius:18px;padding:28px;background:linear-gradient(180deg,rgba(20,0,0,0.95),rgba(40,0,0,0.92));border:1px solid rgba(255,0,0,0.06);box-shadow:0 30px 80px rgba(0,0,0,0.7),inset 0 0 30px rgba(255,0,0,0.02)}
    h1{font-family:'UnifrakturCook',serif;font-size:2.2rem;margin:0 0 12px;color:var(--accent);text-shadow:0 0 10px rgba(255,0,0,0.08)}
    p.description{font-family:'Share Tech Mono',monospace;color:#ffcfcf;margin:6px 0 18px}

    form{display:flex;flex-direction:column;gap:12px}
    label{font-family:'Share Tech Mono',monospace;color:#ffcfcf}
    input[type=text], input[type=number], textarea, select{padding:12px;border-radius:10px;border:1px solid rgba(255,0,0,0.06);background:linear-gradient(145deg,#080000,#120000);color:#ffdede;font-family:'Share Tech Mono';outline:none}
    textarea{min-height:96px;resize:vertical}

    .row{display:flex;gap:12px;align-items:center}
    .col{flex:1}

    /* imagen */
    .imagen-row{display:flex;gap:12px;align-items:center}
    .imagen-preview{width:128px;height:96px;border-radius:8px;object-fit:cover;border:2px solid rgba(255,0,0,0.08);background:#0a0000;display:block}
    .imagen-info{font-family:'Share Tech Mono';color:#ffb6b6;font-size:13px}

    .botones{display:flex;gap:12px;justify-content:flex-end;margin-top:8px}
    .btn{background:linear-gradient(180deg,var(--accent),#b20000);border:0;color:#111;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 8px 30px rgba(255,0,0,0.12)}
    .btn.gray{background:linear-gradient(180deg,#220000,#3a0000);color:#ffdede;border:1px solid rgba(255,255,255,0.04)}
    .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;box-shadow:none}

    #mensaje{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);z-index:10000;padding:10px 14px;border-radius:10px;background:linear-gradient(135deg,rgba(20,0,0,0.95),rgba(40,0,0,0.85));border:1px solid #7f0000;color:var(--muted);font-family:'Share Tech Mono';opacity:0;pointer-events:none;transition:all .25s}
    #mensaje.show{opacity:1;pointer-events:auto}

    .small-muted{font-family:'Share Tech Mono';color:#ffb6b6;font-size:13px}

    @media(max-width:720px){
      .card{padding:18px}
      .imagen-preview{width:96px;height:72px}
      main{padding:20px}
    }
  </style>
</head>
<body>
  <canvas id="proc-bg" aria-hidden="true"></canvas>

  <main>
    <section class="card" aria-labelledby="titulo">
      <h1 id="titulo">‚ûï Crear art√≠culo</h1>
      <p class="description">Rellena los campos y sube la imagen. Tu alma no es necesaria, pero s√≠ tu sesi√≥n.</p>

      <form id="formArticulo" novalidate>
        <label for="nombre">Nombre</label>
        <input id="nombre" name="nombre" type="text" placeholder="Nombre del art√≠culo" required>

        <div class="row">
          <div class="col">
            <label for="precio">Precio</label>
            <input id="precio" name="precio" type="number" min="0" step="1" placeholder="0" required>
          </div>
          <div style="width:180px">
            <label for="version">Versi√≥n</label>
            <input id="version" name="version" type="text" placeholder="v1.0">
          </div>
        </div>

        <label for="servidor">Servidor</label>
        <input id="servidor" name="servidor" type="text" placeholder="Nombre o IP del servidor">

        <label for="descripcion">Descripci√≥n</label>
        <textarea id="descripcion" name="descripcion" placeholder="Describe el art√≠culo..."></textarea>

        <label>Imagen (opcional)</label>
        <div class="imagen-row">
          <img id="previewImg" class="imagen-preview" alt="Previsualizaci√≥n" src="placeholder.png">
          <div style="flex:1">
            <div class="imagen-info" id="nombreImagen">Ninguna imagen elegida</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button type="button" class="btn gray" id="btnSelect">üìÅ Elegir archivo</button>
              <button type="button" class="btn gray" id="btnRemove" style="display:none">‚úñ Quitar</button>
              <input id="imagenFile" name="imagen" type="file" accept="image/*" style="display:none">
            </div>
            <div class="small-muted" style="margin-top:8px">Recomendado: PNG/JPG. M√°x 5MB.</div>
          </div>
        </div>

        <div class="botones">
          <button type="button" class="btn gray" id="btnCancelar">‚Ü© Volver</button>
          <button type="submit" class="btn" id="btnEnviar">üíæ Publicar</button>
        </div>
      </form>
    </section>
  </main>

  <div id="mensaje" role="status" aria-live="polite"></div>

  <script>
    /* ---------------- CONFIG ---------------- */
    const API_BASE = 'http://localhost:3000'; // ajusta si tu API est√° en otra parte
    const MAX_FILE_BYTES = 5 * 1024 * 1024; // 5 MB

    /* ---------------- HELPERS ---------------- */
    function showToast(text, ms = 3500) {
      const el = document.getElementById('mensaje');
      el.textContent = text;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), ms);
    }

    async function safeFetch(url, options = {}) {
      const fullUrl = url.startsWith('/') ? (API_BASE + url) : url;
      try {
        const res = await fetch(fullUrl, options);
        const ct = res.headers.get('content-type') || '';
        if (!res.ok) {
          if (ct.includes('application/json')) {
            const j = await res.json();
            throw j;
          } else {
            throw { message: 'Server error', status: res.status };
          }
        }
        if (ct.includes('application/json')) return res.json();
        return res.text();
      } catch (err) {
        throw err;
      }
    }

    /* ---------------- DOM ---------------- */
    const form = document.getElementById('formArticulo');
    const nombreEl = document.getElementById('nombre');
    const precioEl = document.getElementById('precio');
    const versionEl = document.getElementById('version');
    const servidorEl = document.getElementById('servidor');
    const descripcionEl = document.getElementById('descripcion');
    const imagenFileEl = document.getElementById('imagenFile');
    const btnSelect = document.getElementById('btnSelect');
    const btnRemove = document.getElementById('btnRemove');
    const previewImg = document.getElementById('previewImg');
    const nombreImagen = document.getElementById('nombreImagen');
    const btnEnviar = document.getElementById('btnEnviar');
    const btnCancelar = document.getElementById('btnCancelar');

    let userId = null;

    /* ---------------- verificar sesi√≥n / IP ---------------- */
    function continuarSiVerificado(cb) {
      // verificarId.js debe exponer verificarID(callback)
      try {
        if (typeof verificarID === 'function') {
          verificarID(cb);
          return;
        }
      } catch (e) { /* fallthrough */ }
      // fallback: usar sessionStorage
      cb();
    }

    continuarSiVerificado(() => {
      userId = sessionStorage.getItem('userId');
      if (!userId) {
        showToast('No hay sesi√≥n activa. Redirigiendo...');
        setTimeout(() => location.href = 'index.html', 900);
        return;
      }
      // todo ok, se queda en la p√°gina
    });

    /* ---------------- selecci√≥n de imagen ---------------- */
    btnSelect.addEventListener('click', () => imagenFileEl.click());
    btnCancelar.addEventListener('click', () => { location.href = 'tienda.html'; });

    imagenFileEl.addEventListener('change', () => {
      const f = imagenFileEl.files && imagenFileEl.files[0];
      if (!f) {
        clearImage();
        return;
      }
      if (f.size > MAX_FILE_BYTES) {
        showToast('Archivo demasiado grande. M√°x 5MB.');
        imagenFileEl.value = '';
        return clearImage();
      }
      // Solo im√°genes
      if (!f.type.startsWith('image/')) {
        showToast('El archivo no es una imagen v√°lida.');
        imagenFileEl.value = '';
        return clearImage();
      }
      const url = URL.createObjectURL(f);
      previewImg.src = url;
      nombreImagen.textContent = f.name;
      btnRemove.style.display = 'inline-block';
    });

    btnRemove.addEventListener('click', () => {
      imagenFileEl.value = '';
      clearImage();
    });

    function clearImage() {
      previewImg.src = 'placeholder.png';
      nombreImagen.textContent = 'Ninguna imagen elegida';
      btnRemove.style.display = 'none';
    }

    /* ---------------- validaci√≥n ---------------- */
    function validarCampos() {
      const nombre = nombreEl.value.trim();
      const precio = precioEl.value;
      if (!nombre) { showToast('El nombre es obligatorio'); nombreEl.focus(); return false; }
      if (precio === '' || isNaN(Number(precio)) || Number(precio) < 0) { showToast('Precio inv√°lido'); precioEl.focus(); return false; }
      // opcional: descripci√≥n > l√≠mite
      if (descripcionEl.value.length > 2000) { showToast('Descripci√≥n demasiado larga'); descripcionEl.focus(); return false; }
      return true;
    }

    /* ---------------- submit ---------------- */
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!validarCampos()) return;

      if (!userId) {
        showToast('Sesi√≥n perdida. Refresca la p√°gina.');
        return;
      }

      // preparar FormData
      const fd = new FormData();
      fd.append('creador', userId);
      fd.append('nombre', nombreEl.value.trim());
      fd.append('precio', precioEl.value);
      fd.append('version', versionEl.value.trim());
      fd.append('servidor', servidorEl.value.trim());
      fd.append('descripcion', descripcionEl.value.trim());
      const file = (imagenFileEl.files && imagenFileEl.files[0]) ? imagenFileEl.files[0] : null;
      if (file) fd.append('imagen', file, file.name);

      // desactivar bot√≥n mientras sube
      btnEnviar.disabled = true;
      btnEnviar.textContent = 'Subiendo...';

      try {
        // En el servidor espera un endpoint para crear art√≠culo que acepte multipart/form-data.
        // Ajusta '/crear-articulo' al endpoint real si difiere.
        const res = await fetch(API_BASE + '/crear-articulo', {
          method: 'POST',
          body: fd
          // NOTA: no poner headers para multipart, el navegador lo gestiona
        });

        if (!res.ok) {
          let message = `Error servidor (${res.status})`;
          try { const j = await res.json(); message = j.message || JSON.stringify(j); } catch(_) {}
          throw new Error(message);
        }

        const data = await res.json().catch(() => ({ ok: true }));
        // Asumimos √©xito si status ok
        showToast('Art√≠culo creado correctamente');
        // redirigir a tienda o limpiar form
        setTimeout(() => location.href = 'tienda.html', 700);

      } catch (err) {
        console.error('Error subiendo art√≠culo:', err);
        showToast('Error al crear art√≠culo: ' + (err.message || 'red'));
        btnEnviar.disabled = false;
        btnEnviar.textContent = 'üíæ Publicar';
      }
    });

    /* ---------------- Procedural background (mismo estilo tienda) ---------------- */
    (function(){
      const canvas = document.getElementById('proc-bg');
      const ctx = canvas.getContext && canvas.getContext('2d');
      if (!ctx) return;
      let w,h,dpr=Math.min(window.devicePixelRatio||1,2), t0=performance.now();
      function resize(){ w=innerWidth; h=innerHeight; canvas.width=Math.round(w*dpr); canvas.height=Math.round(h*dpr); canvas.style.width=w+'px'; canvas.style.height=h+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); }
      window.addEventListener('resize', resize); resize();
      function loop(now){ const t=(now-t0)*0.001; ctx.clearRect(0,0,w,h);
        const grd = ctx.createLinearGradient(0,0,w,h); grd.addColorStop(0, '#120000'); grd.addColorStop(1, '#050000'); ctx.fillStyle = grd; ctx.fillRect(0,0,w,h);
        for(let i=0;i<12;i++){ const x = (Math.sin(t*0.3 + i)*0.5+0.5)*w; const y = (Math.cos(t*0.27 + i*1.3)*0.5+0.5)*h; const r = 80 + (i*6)%100; const g = ctx.createRadialGradient(x,y,r*0.1,x,y,r); g.addColorStop(0, 'rgba(255,58,58,0.08)'); g.addColorStop(1, 'rgba(0,0,0,0)'); ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
        ctx.fillStyle='rgba(0,0,0,0.25)'; ctx.fillRect(0,0,w,h);
        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);
    })();
  </script>
</body>
</html>
